$(function(){function e(){return"undefined"!=typeof group}function t(){return"undefined"!=typeof favorite}function o(){return!!$("#timelines").length}if($("#albums-overview").length){var i=170,n=function(e){return $(e).parents(".overview-wrapper").attr("id").slice(6)},a=function(e){return $(e).parents(".overview-wrapper").attr("id").slice(7)},r=function(){return!dragMode&&window.innerWidth>567&&!$.browser.mobile};$(".overview-group .preview").on("mouseenter",function(){r()&&$("#group_"+n(this)+"_actions").fadeIn(i)}),$(".overview-group .preview").on("mouseleave",function(){r()&&$("#group_"+n(this)+"_actions").fadeOut(i)}),$(".overview-folder .preview").on("mouseenter",function(){r()&&$("#folder_"+a(this)+"_actions").fadeIn(i)}),$(".overview-folder .preview").on("mouseleave",function(){r()&&$("#folder_"+a(this)+"_actions").fadeOut(i)}),$(".group-action-delete").click(function(e){e.preventDefault();var t=$(this),o=function(){t.closest(".overview-group").remove();var e=!!$("#outside-drop").length,o=!$(".overview-group").length;e&&o?refreshPage("/"):notice.show("success","Photo album deleted.")};return confirmRemoteLink({text:t.data("confirmation"),target:t.attr("href"),after:o}),!1}),$(".group-action-unbookmark").click(function(e){e.preventDefault();var t=$(this);return confirmRemoteLink({text:{main:t.data("confirmation"),sub:t.data("subconfirmation")},target:t.attr("href")}),!1}),$("#folder-actions .overview-expand").on("click",function(){$("#folder-actions .overview-collapse-menu").toggleClass("shown")}),$("#folder-actions").length&&window.history.replaceState(null,null,window.location.pathname),$("#main").on("click",".drag-handle",function(){var e=$(this).siblings("a");0!=e.length&&(afterDragMode||(window.location.href=e[0].href))}),$("#favorites-tooltip .favorite-entry .delete").on("click",function(e){e.preventDefault();var t=+$(this).data("favorite");favoriteListDelete(t),$("#favorites-tooltip").hide()}),initializeFixedTooltip("#show-favorites","#favorites-tooltip"),initializeFixedTooltip("#folder-actions-expand","#folder-actions-tooltip")}if(window.linear_partition_js){var l=function(e){for(var t=$(e).find(".timeline-entry"),o=0;o<t.length;o++){var i=$(t[o]);if(i.data("dimensions")&&!i.data("ratio")){var n=i.data("dimensions");n=n.slice(n.indexOf("large")).match(/\d+/g);var a=+n[0],r=+n[1],l=a/r;i.data("ratio",l)}}},s=new Worker(window.linear_partition_js),c={};s.onmessage=function(e){if(0!=$("#timelines").length){var t=$(".timeline-entries").width(),o=($(window).height(),$("#"+e.data.date).find(".timeline-entries")[0]),i=$(o).find(".timeline-entry"),n="0px"==i.last().css("width");n&&(i=i.not(".more"));var a=e.data.partition,r=0;$.each(a,function(e,o){var n=[];$.each(o,function(){n.push(i[r++])});var a=0;$.each(n,function(e,t){a+=$(t).data("ratio")}),$.each(n,function(e,o){$(o).css({width:Math.floor(t/a*$(o).data("ratio")),height:Math.floor(t/a)})})}),n&&$(o).find(".timeline-entry.more").remove(),c[e.data.date]=!1}},s.onerror=function(e){c[e.data.date]=!1},window.resetPartitioning=function(){c={}};var d=function(e){var t=$(".timeline-entries").width(),o=$(window).height(),i=Number($("#timelines").data("height")),n=Math.floor(o*i),a=$(e).find(".timeline-entry"),r="0px"==a.last().css("width");r&&(a=a.not(".more"));var l=0;$.each(a,function(e,t){l+=$(t).data("ratio")*n});var d=Math.round(l/t);if(1==a.length&&(d=0),1>d)$.each(a,function(e,o){var i=Math.min(t/$(o).data("ratio")/n,1);$(o).css({width:$(o).data("ratio")*n*i,height:n*i})});else{if(e=$(e).parent().attr("id"),c[e])return;c[e]=!0;var h=$.map(a,function(e){return Math.floor(100*$(e).data("ratio"))});s.postMessage({seq:h,k:d,date:e})}};window.resizeOverviewTimelines=function(e){0!=$("#timelines").length&&(("object"!=typeof e||"object"!=typeof e[0])&&(e=$(".timeline-entries")),$.each(e,function(e,t){l(t),d(t)}))},$(window).on("resize",resizeOverviewTimelines),resizeOverviewTimelines(),$("#main").on("click",".timeline-entry.more",function(){var e=$(this).find(".more-label");if(!e.hasClass("more-loading")){e.addClass("more-loading"),e.html("<div>Loading</div>"),$("#timeline-more-loader img").clone().appendTo(e.find("div"));var t=$(this),o=t.attr("id").replace("-more",""),i=more[o],n="overview-timelines timeline-entry show-large-box",a=t.parent(),r=$(".photo-download").attr("title"),l=$(".photo-download").html();setTimeout(function(){var e="";$.each(i,function(t,o){e+="<div id='"+o.id+"-photo' class='"+n+"'                         data-photo='"+o.id+"'                         data-dimensions='"+o.dimensions+"'                         style='width: 0; height: 0;'>                      <img class='photo' src='"+o.photo+"' onload='onTimelineImgLoad(this)'>                      <div class='timeline-photo-selection'></div>                                                                                        <div class='control-btns lg-only not-touch'>                        <a class='photo-download' href='"+o.original+"' download referrerpolicy='origin' title='"+r+"'>                          "+l+"                        </a>                      </div>                    </div>"}),a.append(e),resizeOverviewTimelines(a)},0)}}),window.onTimelineImgLoad=function(e){var t=e.naturalWidth/e.naturalHeight,o=$(e).parent().data("ratio"),i=Math.abs(t-o);.001>i||($(e).parent().data("ratio",t),resizeOverviewTimelines($(e).closest(".timeline-entries")))},window.setTimelinePage=function(e){-1==timelinesLoaded.indexOf(e)&&loadTimelinePage(e),scrollToTimelinePage(e)},$("#page-header, #main").on("click",".timeline-datepicker .prev-month, .timeline-datepicker .next-month",function(){var e=$(this).hasClass("prev-month")?-1:1,t=+$(this).siblings("select").val()+e;setTimelinePage(t)}),$("#page-header, #main").on("change",".timeline-datepicker select",function(){var e=+$(this).val();setTimelinePage(e),this.blur(),$(this).closest(".top-datepicker").length&&$(this).val(1)})}if($(".add-group-btn").length&&$("body").on("click","#modal-new-group #create-new-group",function(){if(!$(this).find(".send-label").hasClass("hidden")){var e=$(this),t=$(this).data("url"),o=$(this).data("shortcode"),i=$("#modal-new-group #group_name").val(),n=$("#modal-new-group #group_folder").val(),a=$("#modal-new-group #group_privacy").val();$.ajax({url:t,method:"POST",data:{in_folder:!!n.length,folder_id:n,group:{name:i,shortcode_url:o,privacy:a}},beforeSend:function(){e.find(".send-label").addClass("hidden"),e.find(".sent-label").removeClass("hidden")}})}}),$("#large-box").length&&largeBox.initialize(),$("#photos-overview").length&&"object"==typeof group&&loadOverview({group_id:group.id,user_id:user_id,photo_ids:photo_ids}),$("#favorite-overview").length&&"object"==typeof favorite&&loadFavOverview({favorite_id:favorite.id,user_id:user_id}),$("#albums-overview").length||$("#photos-overview").length||$("#favorite-overview").length){$(window).on("popstate",function(){if(null!=history.state)if(e()){if(history.state.upload)return refreshPage("/"+group.shortcode+"/upload");loadOverview({group_id:group.id,user_id:history.state.user_id,photo_ids:history.state.photo_ids,hash:history.state.hash})}else t()&&loadFavOverview({favorite_id:favorite.id,user_id:history.state.user_id,hash:history.state.hash})}),$("#main").on("click",".overview-size, .overview-page-link, .overview-small-page-link, .sort-link > a, .contributor-link, .show-all-contributors-link",function(){pushState()}),$("#main").on("click",".btn.overview-expand",function(){$("#overview-collapsable").toggleClass("shown")}),$("#main").on("click",".btn.overview-select",function(){var e,t,o=window.scrollY+window.innerHeight;t=$("timeline"==window.currentSize?".timeline-entry:not(.more) .timeline-photo-selection":".photo-selection.not-lg");for(var i=0;i<t.length;i++)if($(t[i]).offset().top>o){e=t[Math.max(i-1,0)];break}$("#overview-collapsable-persistent").removeClass("shown"),$(e).click()}),$("#main").on("click",".btn.overview-expand-persistent",function(){$("#overview-collapsable-persistent").toggleClass("shown"),overviewResizePersistentHeader()}),window.overviewResizeSelectActions=function(){if($(".select-mode-actions").length){$(".select-mode-actions span.btn").removeClass("hidden"),$(".select-mode-actions").removeClass("collapsed");var e=function(){var e,t,o=!1;return $(".select-mode-actions").each(function(i,n){e=$(n).find("> span.btn:not(.selected-collapsed)").first(),t=$(n).find("> span.btn:not(.selected-collapsed)").last(),e.offset().top!=t.offset().top&&(o=!0)}),o};e()&&$(".select-mode-actions").addClass("collapsed"),$("#select-actions-tooltip").css("display","none")}},window.overviewResizePageHeader=function(){if(0!=$(".mode-buttons").length){var e=$("#page-header .mode-buttons").position().left,t=$("#page-header h1").css("padding-left").replace("px","");$("#page-header h1").css("max-width",e-t)}},window.overviewResizeHeader=function(){var e=$("#overview-header > ul > .overview-collapsing").first(),t=$("#overview-header > ul > .overview-collapsing").last(),o=$("#overview-header > .overview-info");window.innerWidth>=768&&(t=$("#overview-header > ul > .overview-collapsing:not(.not-lg)").last());var i=function(){return e.offset()?e.offset().top!=t.offset().top:!1},n=function(){return window.innerWidth<768||!o.offset()?!1:o.offset().left<t.offset().left+t.width()};if($("#overview-header .collapsed").removeClass("collapsed"),o.removeClass("hidden"),i()&&($("#overview-header .overview-collapsing").addClass("collapsed"),$("#overview-header .overview-expanding").addClass("collapsed")),n()&&o.addClass("hidden"),$("#notify").length&&$(".top-datepicker").length){var a=$("#notify").hasClass("short");switchClass(".top-datepicker","pad-top",!a)}},window.overviewResizePersistentHeader=function(e){if($("#overview-page").length){var t=$("#overview-page").offset().top;if(window.scrollY>t?($("#overview-header-persistent").addClass("visible"),overviewFixPersistentTooltip()):($("#overview-header-persistent").removeClass("visible"),$("#overview-collapsable-persistent").removeClass("shown")),favoritesFixPersistentTooltip(),!e||"scroll"!=e.type){var o=function(){return $("#overview-header-persistent > ul").height()>40};$("#overview-header-persistent").removeClass("collapsed"),o()&&$("#overview-header-persistent").addClass("collapsed");var i="timeline"==window.currentSize&&window.innerWidth<=480;switchClass($("#overview-header-persistent .persistent-header-add-more-btn"),"hidden",i),switchClass($("#overview-header-persistent .mode-buttons .current"),"hidden",i);var n=i?"#overview-header-persistent ul#overview-collapsable-persistent":"#overview-header-persistent > ul";$("#overview-header-persistent .overview-set-size").prependTo(n)}}},window.overviewFixPersistentTooltip=function(){if($("#overview-page").length&&$(".overview-expand-persistent").length){var e=$("style#overview-persistent-override"),t=$(".overview-expand-persistent"),o=$("#overview-collapsable-persistent");o.removeAttr("style");var i=0;o.children().each(function(e,t){i+=$(t).width()}),i+=26,o.css("width",i);var n=o.offset().left,a=n+o.width(),r=n-(window.innerWidth-a),l=r/2;o.css("right",l);var s=t.offset().left-o.offset().left+30,c=32;if(c>s){var r=c-s;s=c,o.css("right",l+r)}e.html("         #overview-collapsable-persistent::before,         #overview-collapsable-persistent::after         { left: "+s+"px !important }")}},window.favoritesFixPersistentTooltip=function(){if($("#show-favorites").length&&$("#favorites-tooltip").length){var e,t=$("#favorites-tooltip"),o=t.prev(),i="";$("#overview-header-persistent").hasClass("visible")?(e=$("#overview-header-persistent #show-favorites"),i="#favorites-tooltip {                  position: fixed;                  top: 25px !important;                }"):e=$("#page-header #show-favorites");var n=window.innerWidth/2-t.width()/2,a=Math.floor(e.offset().left-n+.8*e.width());i+="#favorites-tooltip .tooltip::before { left: "+a+"px !important; }               #favorites-tooltip .tooltip::after  { left: "+a+"px !important; }",o.text(i)}},window.overviewPrevNextResize=function(){if($(".large-container").length){var e=Number($("#main").css("padding-left").slice(0,-2));$(".prev-page-img, .next-page-img").css({"max-width":Math.max($(window).width()-2*e,300)});var t=$(".photo-container").width(),o=t-$(".cur-img").width();32>o&&(t+=32-o),$(".prev-page-img").css("right",t),$(".next-page-img").css("left",t)}},window.hideTooltip=function(){$(".tooltip-wrapper").each(function(e,t){t=$(t),"block"==t.css("display")&&t.offset().top+t.height()<window.scrollY&&t.fadeOut("fast")})},window.hideExpandedPersistentHeader=function(){$("#overview-collapsable-persistent").removeClass("shown")},$(window).on("resize",overviewResizeSelectActions),$(window).on("resize",overviewResizePageHeader),$(window).on("resize",overviewResizeHeader),$(window).on("resize",overviewPrevNextResize),$(window).on("resize",overviewFixPersistentTooltip),$(window).on("scroll resize",overviewResizePersistentHeader),$(window).on("scroll",hideTooltip),$(window).on("scroll",hideExpandedPersistentHeader),$(window).on("scroll",adjustTooltipScroll),favoritesFixPersistentTooltip(),setTimeout(overviewResizePageHeader,500),initializeOverviewTooltip("#photos-sort","#photos-sort-tooltip"),initializeOverviewTooltip("#contributors","#contributors-tooltip"),initializeHeaderTooltip("#header-expand","#header-collapsed-tooltip"),initializeFixedTooltip("#select-actions-expand","#select-actions-tooltip"),$(window).on("resize",function(){fixTooltipPosition("#photos-sort-tooltip"),fixTooltipPosition("#contributors-tooltip"),fixTooltipSize("#header-collapsed-tooltip")}),$("#main").on("click","#contributors-prev-page.active, #contributors-next-page.active",function(){$.ajax({url:"/group/contributors_overview_pagination",data:{group_id:$(this).data("group"),page:$(this).data("page"),user_id:user_id,photo_ids:photo_ids}})}),window.largeOverviewResize=function(e){if($(".large-container").length){"string"!=typeof e&&(e="cur");var t=($(".large-container > .photo-container"),$("."+e+"-img")),o=$(".large-title"),i=$(".large-photo-info"),n=$(".large-overlay");i.removeAttr("style");var a=t.width(),r=+$(".large-container").css("min-width").replace("px","");r>a&&(a=r),i.css("max-width",a),o.css("max-width",a),n.css("width",a)}},window.adjustSmControls=function(){var e=$(".large-sm-overlay"),t=$(".large-sm-overlay .controls");if(e.length&&t.length){var o=.5*window.innerHeight+window.scrollY+t.height(),i=e.offset().top+e.height();o>i&&window.scrollY>50?t.css("opacity",.5):t.css("opacity",1)}},$(window).on("resize",largeOverviewResize),$(window).on("scroll",adjustSmControls),window.pages=[],window.loadedPhotos=0;var h;window.setPage=function(o){var i=$(".overview-large");if(i.length){currentPage=o;var n=pages[--o],a=o>0&&pages[o-1],r=pages[o+1];i.attr("id",n.id);var l=function(e,t){t&&$(e+"-img").attr("src",t.url),switchClass(e+"-img","hidden",!t),switchClass(".large-overlay "+e+"-btn","blank-btn",!t),switchClass(".controls "+e+"-btn","hidden",!t)};l(".prev-page",a),l(".next-page",r),h||(h=setTimeout(function(){$(".loading").css("opacity",1),$(".photo-container > img").css("opacity",0)},50)),$(".cur-img").attr("src",n.url),$(".context-menu-img").attr("src",n.url),$(".photo-download-btn").attr("href",n.original);var s=n.title||$("#overview-page").data("notitle");if(updateInlineEdit({el:".inline-edit-wrap-photo-title-large",context:"title",id:n.id,content:s,changeable:n.changeable}),switchClass(".inline-edit-wrap-photo-title-large .get .inline-edit","blank",!n.title),switchClass(".large-overlay .photo-delete-btn","blank-btn",!n.changeable),switchClass(".large-overlay .photo-rotate-btn","blank-btn",!n.changeable),switchClass(".actions .photo-delete-btn","hidden",!n.changeable),switchClass(".actions .photo-rotate-btn","hidden",!n.changeable),$(".large-photo-info .large-user").html(n.user),loadComments){var c=-1!=document.cookie.indexOf("show_comments=true");$("#comments-container").length?c&&($(".large-photo-info .submit-comment .submit-btn").addClass("disabled"),overviewLargeComments(n.id)):overviewLargeComments(n.id)}$(".photo-container > img").off("load"),$(".photo-container > img").on("load",function(){largeOverviewResize(),adjustSmControls(),$(this).hasClass("cur-img")&&(clearTimeout(h),h=void 0,$(".loading").css("opacity",0)),$(this).css("opacity",1)}),overviewPrevNextResize(),largeOverviewResize(),setTimeout(largeOverviewResize,500),replaceState();var d=Math.ceil(loadedPhotos/perPage);d<totalPages&&currentPage>loadedPhotos-preload&&"timeline"!=currentSize&&(e()?addOverview({group_id:group.id,user_id:user_id,photo_ids:photo_ids,page:d,size:"large"}):t()&&addFavOverview({favorite_id:favorite.id,user_id:user_id,page:d,size:"large"}),loadedPhotos+=perPage)}};var g=function(e){var t,o,i=$(".cur-img");e>0?(t=$(".next-page-img"),o=$(".prev-page-img")):(t=$(".prev-page-img"),o=$(".next-page-img"));var n=t.offset().left-i.offset().left,a=(t.width()-i.width())/2,r=-z*e+n+a+10;z=0,$(".photo-container").removeClass("smooth"),i.css("transform","translate3d("+r+"px, 0, 0)"),t.css("transform","translate3d("+r+"px, 0, 0)"),o.css("transform","translate3d("+(r-a*e)+"px, 0, 0)"),setPage(currentPage+e),$(".photo-container").addClass("smooth"),M(),setTimeout(function(){$(".photo-container").removeClass("smooth"),M(),$(".photo-container > img").hide().show(0)},200)},p=function(){return!$(".prev-page-btn").hasClass("hidden")},u=function(){return!$(".next-page-btn").hasClass("hidden")};$("#main").on("click",".large-overlay .prev-page-btn, .large-sm-overlay .prev-page-btn",function(e){e.preventDefault(),$(this).hasClass("blank-btn")||g(-1)}),$("#main").on("click",".large-overlay .next-page-btn, .large-sm-overlay .next-page-btn",function(e){e.preventDefault(),$(this).hasClass("blank-btn")||g(1)}),$(document).on("keydown",function(e){if($(".large-container").length&&!$("#slideshow").length){var t=e.target.tagName.toLowerCase(),o=e.target.getAttribute("type"),i=37,n=39;"input"==t&&"checkbox"!=o||"textarea"==t||(e.keyCode==i&&p()?g(-1):e.keyCode==n&&u()&&g(1))}});var v=".large-sm-overlay .controls",f=".large-sm-overlay .actions",w=!0;$(document).on("click",function(){w||($(v).fadeIn(),$(f).fadeOut()),w=!1}),$("#main").on("click",".large-sm-overlay",function(e){if(!e.isDefaultPrevented()&&!C&&-1!=$(".cur-img").css("transform").indexOf("1, 0, 0, 1, 0, 0")){var t=200,o="none"==$(f).css("display");o?($(f).fadeIn(t),$(v).fadeOut(t),w=!0):($(v).fadeIn(t),$(f).fadeOut(t))}}),$("#main").on("click",".photo-delete-btn",function(o){o.preventDefault();var i=$(this).parents(".overview-large").attr("id");e()&&overviewLargeDelete(i,user_id,photo_ids),t()&&favoriteRemove(i)}),$("#main").on("click",".photo-rotate-btn",function(e){e.preventDefault();var t=$(this).parents(".overview-large").attr("id");overviewLargeRotate(t)}),$("#main").on("click",".show-comments-button",function(e){e.preventDefault();var t=$(this).parents(".overview-large").attr("id");$.ajax("/comment/visibility?show=true&photo_id="+t)}),$("#main").on("click",".hide-comments-button",function(e){e.preventDefault();var t=$(this).parents(".overview-large").attr("id");$.ajax("/comment/visibility?show=false&photo_id="+t)}),window.swipeTimeout=!1;var m,x,b,C=!1,B=!1,y=50,k=25,_=50,S=".large-sm-overlay, .large-overlay",z=0,P=function(e){return"touchstart"==e.type?e.originalEvent.touches[0].pageX:"touchmove"==e.type||"touchend"==e.type?e.originalEvent.changedTouches[0].pageX:e.pageX},T=function(e){return"touchstart"==e.type?e.originalEvent.touches[0].pageY:"touchmove"==e.type||"touchend"==e.type?e.originalEvent.changedTouches[0].pageY:e.pageY},M=function(){$(".photo-container > img").css("transform","translate3d(0, 0, 0)")};$("#main").on("mousedown touchstart",S,function(e){if(!swipeTimeout&&!$("#overview-page").hasClass("select-mode")&&"none"==$(".large-sm-overlay .actions").css("display")){if(e.which>1)return C=!1,void M();overviewPrevNextResize(),C=!0,m=P(e),x=T(e),b=$(window).scrollTop(),B=!1}}),$("#main").on("mousemove touchmove",S,function(e){if(C){var t=P(e),o=T(e),i=($(".large-sm-overlay .prev-page-btn"),$(".large-sm-overlay .next-page-btn"),m-t),n=x-o;z=Math.min(Math.abs(i),600);var a=Math.max(Math.min(-i,600),-600),r=3*z>=y;if(e.preventDefault(),r?($(".photo-container > img").css("transform","translate3D("+a+"px, 0, 0)"),B=!1):M(),window.innerWidth>=768&&!$("body").hasClass("touchscreen"))return;B?window.scrollBy(0,n):B=!r&&Math.abs(n)>k&&Math.abs(i)<_}}),$("#main").on("mouseup mouseleave touchend",S,function(e){if(C){var t=P(e);C=!1,Math.abs(t-m)>y?(t>m&&p()?g(-1):m>t&&u()?g(1):M(),setTimeout(function(){C=!1},0)):M(),swipeTimeout||raise("swipeTimeout",100)}});var O=function(){return $("#overview-page").hasClass("select-mode-reversed")},I=function(){return $("."+currentSize+"-container.selected").length},R=function(){var e=0;return $(".timeline-container.selected").each(function(t,o){e+=$(o).find(".timeline-entry:not(.more)").length,$(o).find(".more").length&&(date=o.id.replace("-date",""),more[date]&&(e+=more[date].length))}),e+=$(".timeline-container:not(.selected) .timeline-entry.selected").length,e-=$(".timeline-container.selected .timeline-entry.selected").length},F=function(){if(window.photos&&"timelines"==window.timelineType){for(var e=getSelectedIds(),t=!0,o=0;o<e.length;o++)if(!photos[e[o]].changeable){t=!1;break}switchClass(".unchangeables","hidden",t)}},D=function(){var e;e=o()?R():O()?photoCount-I():I(),$(".select-mode-actions .select-counter").text(e+" selected"),F()};$("#main").on("click",".photo-selection",function(){var e=$(this).parents("."+currentSize+"-container");if(e.toggleClass("selected"),O()){if(I()>=photoCount)return void endSelectMode()}else{if(I()<=0)return endSelectMode(),void("large"==currentSize&&$(f).css("display","block"));$("."+currentSize+"-container").hasClass("select-mode")||startSelectMode()}D()}),$("#main").on("click",".timeline-selection",function(){$("#timelines").hasClass("select-mode")||startSelectMode();var e=$(this).parents(".timeline-container"),t=e.hasClass("selected"),o=e.find(".timeline-entry.selected").length>0;t&&!o?e.removeClass("selected"):e.addClass("selected"),e.find(".timeline-entry").removeClass("selected"),D(),R()<=0&&endSelectMode()}),$("#main").on("click",".timeline-photo-selection",function(e){$("#timelines").hasClass("select-mode")||startSelectMode(),$(this).parents(".timeline-entry").toggleClass("selected");var t=$(this).parents(".timeline-container"),o=t.hasClass("selected"),i=t.find(".timeline-entry.more").length>0,n=t.find(".timeline-entry:not(.more)").length==t.find(".timeline-entry.selected").length;o&&n&&!i?(t.removeClass("selected"),t.find(".timeline-entry.selected").removeClass("selected")):!o&&n&&t.find(".timeline-selection").click(),D(),e.stopPropagation(),R()<=0&&endSelectMode()}),$("body").on("click",".end-select-mode",endSelectMode),$("body").on("click",".select-mode-actions .select-all",function(){o()?($(".timeline-container").addClass("selected"),$(".timeline-entry").removeClass("selected")):startSelectModeReversed(),D()}),window.getSelectedIds=function(){var e=[];return o()?$(".timeline-container").each(function(t,o){if($(o).hasClass("selected")){if($(o).find(".timeline-entry:not(.more):not(.selected)").each(function(t,o){e.push(+o.id.replace("-photo",""))}),$(o).find(".timeline-entry.more").length){var i=o.id.replace("-date","");$.each(window.more[i],function(t,o){e.push(o.id)})}}else $(o).find(".timeline-entry.selected").each(function(t,o){e.push(+o.id.replace("-photo",""))})}):$("."+currentSize+"-container.selected").each(function(t,o){e.push("large"==currentSize?+$(o).parent().attr("id"):+$(o).parent().attr("id").replace("-photo",""))}),e},$("body").on("click",".selected-delete",function(){var e,t=getSelectedIds(),o=$("#overview-page").hasClass("select-mode-reversed");e=o?photoCount-t.length:t.length;var i=$(this).data("confirm").replace("%{count}",e).replace("%{plural}",e>1?"s":""),n=$(this).data("link")+t.join(",")+"&hash="+getHash();o&&(n=n.replace("ids=","except=")),confirmLink({text:i,target:n})}),$("body").on("click",".selected-download, .selected-share, .selected-rename",function(){var e=getSelectedIds().join(","),t=$(this).data("link")+e,o=$("#overview-page").hasClass("select-mode-reversed");o&&(t=t.replace("ids=","except=")),opts={},$(this).hasClass("selected-rename")&&(opts={async:!1}),$.ajax(t,opts)}),$("body").on("click",".selected-favorite, .selected-move, .selected-copy",function(){var e=getSelectedIds(),t=$(this).data("link")+e.join(",");$.ajax(t)}),$("#main").on("click",".comment-edit",function(){$(this).parent().siblings(".comment-body").find(".inline-edit-get").click()}),$(".overview-albums-btn").on("click",function(o){currentSize&&"large"==currentSize&&(o.preventDefault(),e()?loadOverview({size:"medium",page:"calculate",group_id:group.id,user_id:user_id,photo_ids:photo_ids,scrollTo:0}):t()&&loadFavOverview({size:"medium",page:"calculate",favorite_id:favorite.id,user_id:user_id,scrollTo:0}))})}if($("#photos-overview").length||$(".search-overview").length||$("#favorite-overview").length||$("#timelines").length){window.checkScrollNextPage=function(){if(!window.endReached)if("timeline"==window.currentSize){if(0==timelinesLoaded.length)return;var e=Math.max.apply(null,timelinesLoaded);loadMissingTimelines();var t=$(window).scrollTop()+$("#timelines").data("scroll-multiplier")*$(window).height(),o=$("#timelines").offset().top+$("#timelines").height();t>=o&&loadTimelinePage(e+1)}else if("small"==window.currentSize||"medium"==window.currentSize){if(!$(".scroll").length)return;var t=$(window).scrollTop()+$(".scroll").data("multiplier")*$(window).height(),o=$(".scroll").offset().top;t>=o&&scrollNextPage()}},setInterval(checkScrollNextPage,1e3),window.scrollNextPage=function(){return $(".large-container").length?scrollComments():$(".search-overview").length?scrollSearch():"small"==window.currentSize||"medium"==window.currentSize?scrollOverview():void 0},window.scrollComments=function(){if(!$(".show-comments-button").length&&!window.endReached&&window.currentCommentPage){var e=$(".overview-large")[0].id;window.currentCommentPage++,addComments({photo_id:e,page:window.currentCommentPage})}},window.scrollSearch=function(){window.currentSearchPage++,addSearch({context:window.searchOptions.context,o:window.searchOptions.options,q:window.searchOptions.query,page:window.currentSearchPage})},window.scrollOverview=function(){if(o()){var i=void 0;window.group&&(i=group.id),window.favorite&&(i=favorite.id),addTimeline({is_favorite:t(),group_id:i,user_id:window.user_id,photo_ids:window.photo_ids,page:window.currentPage,size:window.currentSize})}else e()?addOverview({group_id:group.id,user_id:user_id,photo_ids:photo_ids,page:window.currentPage,size:window.currentSize||"medium"}):t()&&addFavOverview({favorite_id:favorite.id,user_id:user_id,page:window.currentPage,size:window.currentSize||"medium"})};var N=function(){if(window.perPage&&-1!=["small","medium","timeline"].indexOf(window.currentSize)){var e,t,o=$(window).scrollTop()+100;"timeline"==window.currentSize?(o+=.5*$(window).height(),$("#timelines .timeline-page-top").each(function(t,i){$(i).offset().top<o&&(e=i)}),t=getTimelinePage(e),updateTimelineDatepicker(t),currentPage=t):$(".overview-"+window.currentSize).each(function(e,i){t||$(i).offset().top>o&&(t=Math.ceil(++e/window.perPage))}),t&&t!=+getHash().slice(1,-1)&&replaceState({page:t||1})}};$(window).on("scroll",N)}if($("#dragbox").length&&$("body").on("click",".inline-edit-shortcode",function(e){e.preventDefault(),ajax({url:"/edit_address?group_id="+this.id,async:!1})}),$("#upload-modals").length&&$(".moderated-ok").on("click",function(){refreshPage(shortcode)}),$(".initial-subheader, .second-subheader").length>=2&&$("form").on("change",function(){$(".initial-subheader").addClass("hidden"),$(".second-subheader").removeClass("hidden")}),$("#sort-page").length&&($("#reset_photos_sort").on("change",function(){window.location="/"+window.shortcode+"/sort/"+$(this).val()}),$(".submit-btn").on("click",function(){$("#sort_accept").submit()})),$("#pending-page").length){$("#review_group").on("change",function(){window.location="/review/"+$(this).val()});var j=function(e,t){var o=t?"accept":"delete",i=t?"delete":"accept";$(e).removeClass(i).addClass(o),$(e).find("."+o+"-pending-opt").removeClass("hidden"),$(e).find("."+i+"-pending-opt").addClass("hidden"),$(e).find(".placeholder-opt").addClass("hidden")},H=function(e){$(".pending-btn").each(function(t,o){j(o,e)})};$(".select-btn").on("click",function(){H(!0)}),$(".deselect-btn").on("click",function(){H(!1)}),$(".pending-btn").on("click",function(){$(this).hasClass("accept")?j(this,!1):j(this,!0)});var L,A=function(e){var t,o=!1;$(".overview-pending").each(function(i,n){o&&(t=t||$(n)),n==e[0]&&(o=!0)}),t&&setTimeout(function(){t.find(".show-preview").click()},0)};$(".show-preview").on("click",function(e){e.preventDefault(),$(".pending-preview > .preview").css("background-image",""),$(".pending-preview .preview > img").removeClass("hidden"),$(".pending-preview .info").html($(this).data("info")),$(".pending-preview .info a").attr("target","_blank"),showInlineModal(".pending-preview"),L=$(this).parent().parent();var t=new Image;t.onload=function(){$(".pending-preview > .preview").css("background-image","url("+t.src+")"),$(".pending-preview .preview > img").addClass("hidden")},t.src=this.href}),$(".accept-preview").on("click",function(){j(L.find(".pending-btn"),!0),A(L)}),$(".delete-preview").on("click",function(){j(L.find(".pending-btn"),!1),A(L)}),$(".submit-btn").on("click",function(e){e.preventDefault();var t=[],o=[];$(".pending-btn").each(function(e,i){$(i).hasClass("accept")?t.push(i.id.slice("photo_".length)):o.push(i.id.slice("photo_".length))}),$("#accept_photo_ids").val(JSON.stringify(t)),$("#delete_photo_ids").val(JSON.stringify(o)),$(".pending-confirm .accept_count").html(t.length),$(".pending-confirm .delete_count").html(o.length),$(".pending-confirm .plural").html(1==t?"":"s"),o.length<=0?($(".pending-confirm .no_deleting").removeClass("hidden"),$(".pending-confirm .deleting").addClass("hidden")):($(".pending-confirm .no_deleting").addClass("hidden"),$(".pending-confirm .deleting").removeClass("hidden")),showInlineModal(".pending-confirm")}),$(".pending-preview").on("click",function(e){e.isDefaultPrevented()||$(".pending-preview").addClass("hidden")}),$(".confirm-pending").on("click",function(){$("#pending_accept").submit()}),$(".cancel-pending").on("click",function(){$(".pending-confirm").addClass("hidden")})}});